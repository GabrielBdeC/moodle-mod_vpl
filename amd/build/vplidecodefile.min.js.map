{"version":3,"file":"vplidecodefile.min.js","names":["define","$","VPLUtil","self","editor","session","readOnly","getFileManager","getOldContent","getContent","isOpen","getValue","call","setOldContent","setContent","c","setValue","oldDestroy","destroy","setFontSize","size","oldAdjustSize","adjustSize","resize","gotoLine","line","scrollToLine","focus","setReadOnly","s","tid","getTId","removeClass","blur","undo","redo","selectAll","hasUndo","getUndoManager","hasRedo","hasSelectAll","returnTrue","hasFind","hasFindReplace","hasNext","find","execCommand","replace","next","getAnnotations","setAnnotations","a","clearAnnotations","langSelection","ext","fileExtension","getFileName","lang","langType","setMode","getEditor","setTheme","theme","open","showFileName","ace","loadScript","fileManager","require","edit","getId","getSession","setOptions","enableBasicAutocompletion","enableSnippets","getFontSize","getTheme","$blockScrolling","setUseSoftTabs","setTabSize","setUndoManager","UndoManager","setOpen","addEventDrop","tag","length","on","dropHandler","button","trigger","setTimeout","change","prevOnPaste","onPaste","restrictedEdit","insert","getClipboard","t","setClipboard","text","restrictedPaste","dragoverHandler","css","close"],"sources":["../src/vplidecodefile.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Code files extension method using ACE editorfiles. Add to VPLFile object.\n *\n * @copyright 2013 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\n/* globals ace */\n\ndefine(\n    [\n        'jquery',\n        'mod_vpl/vplutil',\n    ],\n    function($, VPLUtil) {\n        return function() {\n            var self = this;\n            var editor = null;\n            var session = null;\n            var readOnly = self.getFileManager().readOnly;\n            var getOldContent = this.getContent;\n            this.getContent = function() {\n                if (!this.isOpen()) {\n                    return getOldContent.call(this);\n                }\n                return editor.getValue();\n            };\n            var setOldContent = this.setContent;\n            this.setContent = function(c) {\n                setOldContent.call(this, c);\n                if (this.isOpen()) {\n                    editor.setValue(c);\n                }\n            };\n            var oldDestroy = this.destroy;\n            this.destroy = function() {\n                if (this.isOpen()) {\n                    editor.destroy();\n                }\n                oldDestroy.call(this);\n            };\n            this.setFontSize = function(size) {\n                if (this.isOpen()) {\n                    editor.setFontSize(size);\n                }\n            };\n            var oldAdjustSize = this.adjustSize;\n            this.adjustSize = function() {\n                if (oldAdjustSize.call(this)) {\n                    editor.resize(true);\n                    return true;\n                }\n                return false;\n            };\n            this.gotoLine = function(line) {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.gotoLine(line, 0);\n                editor.scrollToLine(line, true);\n                editor.focus();\n            };\n            this.setReadOnly = function(s) {\n                readOnly = s;\n                if (this.isOpen()) {\n                    editor.setReadOnly(s);\n                }\n            };\n            this.focus = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                var tid = this.getTId();\n                // Workaround to remove JQwery-UI background color.\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\n                editor.focus();\n            };\n            this.blur = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.blur();\n            };\n            this.undo = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.undo();\n                editor.focus();\n            };\n            this.redo = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.redo();\n                editor.focus();\n            };\n            this.selectAll = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.selectAll();\n                editor.focus();\n            };\n            this.hasUndo = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.getUndoManager().hasUndo();\n            };\n            this.hasRedo = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.getUndoManager().hasRedo();\n            };\n            this.hasSelectAll = VPLUtil.returnTrue;\n            this.hasFind = VPLUtil.returnTrue;\n            this.hasFindReplace = VPLUtil.returnTrue;\n            this.hasNext = VPLUtil.returnTrue;\n            this.find = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('find');\n            };\n            this.replace = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('replace');\n            };\n            this.next = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.execCommand('findnext');\n            };\n            this.getAnnotations = function() {\n                if (!this.isOpen()) {\n                    return [];\n                }\n                return session.getAnnotations();\n            };\n            this.setAnnotations = function(a) {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.setAnnotations(a);\n            };\n            this.clearAnnotations = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return session.clearAnnotations();\n            };\n            this.langSelection = function() {\n                if (!this.isOpen()) {\n                    return;\n                }\n                var ext = VPLUtil.fileExtension(this.getFileName());\n                var lang = 'text';\n                if (ext !== '') {\n                    lang = VPLUtil.langType(ext);\n                }\n                session.setMode(\"ace/mode/\" + lang);\n            };\n            this.getEditor = function() {\n                if (!this.isOpen()) {\n                    return false;\n                }\n                return editor;\n            };\n            this.setTheme = function(theme) {\n                if (!this.isOpen()) {\n                    return;\n                }\n                editor.setTheme(\"ace/theme/\" + theme);\n            };\n            this.open = function() {\n                this.showFileName();\n                if (typeof ace === 'undefined') {\n                    VPLUtil.loadScript(['../editor/ace9/ace.js',\n                        '../editor/ace9/ext-language_tools.js'],\n                        function() {\n                            self.open();\n                        });\n                    return false;\n                }\n                if (this.isOpen()) {\n                    return editor;\n                }\n                var fileManager = this.getFileManager();\n                var tid = this.getTId();\n                // Workaround to remove jquery-ui theme background color.\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\n                ace.require(\"ext/language_tools\");\n                editor = ace.edit(\"vpl_file\" + this.getId());\n                session = editor.getSession();\n                editor.setOptions({\n                    enableBasicAutocompletion: true,\n                    enableSnippets: true,\n                });\n                editor.setValue(this.getContent());\n                editor.setFontSize(fileManager.getFontSize());\n                editor.setTheme(\"ace/theme/\" + fileManager.getTheme());\n                editor.$blockScrolling = Infinity;\n                editor.gotoLine(1, 0);\n                editor.setReadOnly(readOnly);\n                session.setUseSoftTabs(true);\n                session.setTabSize(4);\n                // Avoid undo of editor initial content.\n                session.setUndoManager(new ace.UndoManager());\n                this.setOpen(true);\n                this.langSelection();\n                // Code to control Paste and drop under restricted editing.\n                editor.execCommand('replace');\n                var addEventDrop = function() {\n                    var tag = $(tid + ' div.ace_search');\n                    if (tag.length) {\n                        tag.on('drop', fileManager.dropHandler);\n                        var button = $('.ace_searchbtn_close');\n                        button.trigger('click');\n                    } else {\n                        setTimeout(addEventDrop, 50);\n                    }\n                };\n                editor.on('change', function() {\n                    self.change();\n                });\n                // Try to grant dropHandler installation.\n                setTimeout(addEventDrop, 5);\n                // Save previous onPaste and change for a new one.\n                var prevOnPaste = editor.onPaste;\n                editor.onPaste = function(s) {\n                    if (fileManager.restrictedEdit) {\n                        editor.insert(fileManager.getClipboard());\n                    } else {\n                        prevOnPaste.call(editor, s);\n                    }\n                };\n                // Control copy and cut (yes cut also use this) for localClipboard.\n                editor.on('copy', function(t) {\n                    fileManager.setClipboard(t.text);\n                });\n                $(tid).on('paste', '*', fileManager.restrictedPaste);\n                $(tid + ' div.ace_content').on('drop', fileManager.dropHandler);\n                $(tid + ' div.ace_content').on('dragover', fileManager.dragoverHandler);\n                // Workaround to avoid hidden first line in editor.\n                $(tid).find('div.ace_scroller').css('position', 'static');\n                this.adjustSize();\n                $(tid).find('div.ace_scroller').css('position', 'absolute');\n                return editor;\n            };\n            this.close = function() {\n                this.setOpen(false);\n                if (editor === null) {\n                    return;\n                }\n                this.setContent(editor.getValue());\n                editor.destroy();\n                editor = null;\n                session = null;\n            };\n        };\n    }\n);\n"],"mappings":"AAyBAA,MAAM,CACF,CACI,QAAQ,CACR,iBAAiB,CACpB,CACD,SAASC,CAAC,CAAEC,CAAO,CAAE,CACjB,MAAO,WAAW,IACV,CAAAC,CAAI,CAAG,IAAI,CACXC,CAAM,CAAG,IAAI,CACbC,CAAO,CAAG,IAAI,CACdC,CAAQ,CAAGH,CAAI,CAACI,cAAc,EAAE,CAACD,QAAQ,CACzCE,CAAa,CAAG,IAAI,CAACC,UAAU,CACnC,IAAI,CAACA,UAAU,CAAG,UAAW,OACpB,KAAI,CAACC,MAAM,EAAE,CAGXN,CAAM,CAACO,QAAQ,EAAE,CAFbH,CAAa,CAACI,IAAI,CAAC,IAAI,CAGtC,CAAC,CACD,GAAI,CAAAC,CAAa,CAAG,IAAI,CAACC,UAAU,CACnC,IAAI,CAACA,UAAU,CAAG,SAASC,CAAC,CAAE,CAC1BF,CAAa,CAACD,IAAI,CAAC,IAAI,CAAEG,CAAC,CAAC,CACvB,IAAI,CAACL,MAAM,EAAE,EACbN,CAAM,CAACY,QAAQ,CAACD,CAAC,CAEzB,CAAC,CACD,GAAI,CAAAE,CAAU,CAAG,IAAI,CAACC,OAAO,CAC7B,IAAI,CAACA,OAAO,CAAG,UAAW,CAClB,IAAI,CAACR,MAAM,EAAE,EACbN,CAAM,CAACc,OAAO,EAAE,CAEpBD,CAAU,CAACL,IAAI,CAAC,IAAI,CACxB,CAAC,CACD,IAAI,CAACO,WAAW,CAAG,SAASC,CAAI,CAAE,CAC1B,IAAI,CAACV,MAAM,EAAE,EACbN,CAAM,CAACe,WAAW,CAACC,CAAI,CAE/B,CAAC,CACD,GAAI,CAAAC,CAAa,CAAG,IAAI,CAACC,UAAU,CACnC,IAAI,CAACA,UAAU,CAAG,UAAW,SACrBD,CAAa,CAACT,IAAI,CAAC,IAAI,CAAC,GACxBR,CAAM,CAACmB,MAAM,IAAM,IAI3B,CAAC,CACD,IAAI,CAACC,QAAQ,CAAG,SAASC,CAAI,CAAE,CACtB,IAAI,CAACf,MAAM,EAAE,GAGlBN,CAAM,CAACoB,QAAQ,CAACC,CAAI,CAAE,CAAC,CAAC,CACxBrB,CAAM,CAACsB,YAAY,CAACD,CAAI,IAAO,CAC/BrB,CAAM,CAACuB,KAAK,EAAE,CAClB,CAAC,CACD,IAAI,CAACC,WAAW,CAAG,SAASC,CAAC,CAAE,CAC3BvB,CAAQ,CAAGuB,CAAC,CACR,IAAI,CAACnB,MAAM,EAAE,EACbN,CAAM,CAACwB,WAAW,CAACC,CAAC,CAE5B,CAAC,CACD,IAAI,CAACF,KAAK,CAAG,UAAW,CACpB,GAAK,IAAI,CAACjB,MAAM,EAAE,EAGlB,GAAI,CAAAoB,CAAG,CAAG,IAAI,CAACC,MAAM,EAAE,CAEvB9B,CAAC,CAAC6B,CAAG,CAAC,CAACE,WAAW,CAAC,iCAAiC,CAAC,CACrD5B,CAAM,CAACuB,KAAK,EAAE,CAClB,CAAC,CACD,IAAI,CAACM,IAAI,CAAG,UAAW,CACd,IAAI,CAACvB,MAAM,EAAE,EAGlBN,CAAM,CAAC6B,IAAI,EACf,CAAC,CACD,IAAI,CAACC,IAAI,CAAG,UAAW,CACd,IAAI,CAACxB,MAAM,EAAE,GAGlBN,CAAM,CAAC8B,IAAI,EAAE,CACb9B,CAAM,CAACuB,KAAK,EAAE,CAClB,CAAC,CACD,IAAI,CAACQ,IAAI,CAAG,UAAW,CACd,IAAI,CAACzB,MAAM,EAAE,GAGlBN,CAAM,CAAC+B,IAAI,EAAE,CACb/B,CAAM,CAACuB,KAAK,EAAE,CAClB,CAAC,CACD,IAAI,CAACS,SAAS,CAAG,UAAW,CACnB,IAAI,CAAC1B,MAAM,EAAE,GAGlBN,CAAM,CAACgC,SAAS,EAAE,CAClBhC,CAAM,CAACuB,KAAK,EAAE,CAClB,CAAC,CACD,IAAI,CAACU,OAAO,CAAG,UAAW,SACjB,IAAI,CAAC3B,MAAM,EAAE,EAGXL,CAAO,CAACiC,cAAc,EAAE,CAACD,OAAO,EAC3C,CAAC,CACD,IAAI,CAACE,OAAO,CAAG,UAAW,SACjB,IAAI,CAAC7B,MAAM,EAAE,EAGXL,CAAO,CAACiC,cAAc,EAAE,CAACC,OAAO,EAC3C,CAAC,CACD,IAAI,CAACC,YAAY,CAAGtC,CAAO,CAACuC,UAAU,CACtC,IAAI,CAACC,OAAO,CAAGxC,CAAO,CAACuC,UAAU,CACjC,IAAI,CAACE,cAAc,CAAGzC,CAAO,CAACuC,UAAU,CACxC,IAAI,CAACG,OAAO,CAAG1C,CAAO,CAACuC,UAAU,CACjC,IAAI,CAACI,IAAI,CAAG,UAAW,CACd,IAAI,CAACnC,MAAM,EAAE,EAGlBN,CAAM,CAAC0C,WAAW,CAAC,MAAM,CAC7B,CAAC,CACD,IAAI,CAACC,OAAO,CAAG,UAAW,CACjB,IAAI,CAACrC,MAAM,EAAE,EAGlBN,CAAM,CAAC0C,WAAW,CAAC,SAAS,CAChC,CAAC,CACD,IAAI,CAACE,IAAI,CAAG,UAAW,CACd,IAAI,CAACtC,MAAM,EAAE,EAGlBN,CAAM,CAAC0C,WAAW,CAAC,UAAU,CACjC,CAAC,CACD,IAAI,CAACG,cAAc,CAAG,UAAW,OACxB,KAAI,CAACvC,MAAM,EAAE,CAGXL,CAAO,CAAC4C,cAAc,EAAE,CAFpB,EAGf,CAAC,CACD,IAAI,CAACC,cAAc,CAAG,SAASC,CAAC,CAAE,SACzB,IAAI,CAACzC,MAAM,EAAE,EAGXL,CAAO,CAAC6C,cAAc,CAACC,CAAC,CACnC,CAAC,CACD,IAAI,CAACC,gBAAgB,CAAG,UAAW,SAC1B,IAAI,CAAC1C,MAAM,EAAE,EAGXL,CAAO,CAAC+C,gBAAgB,EACnC,CAAC,CACD,IAAI,CAACC,aAAa,CAAG,UAAW,CAC5B,GAAK,IAAI,CAAC3C,MAAM,EAAE,KAGd,CAAA4C,CAAG,CAAGpD,CAAO,CAACqD,aAAa,CAAC,IAAI,CAACC,WAAW,EAAE,CAAC,CAC/CC,CAAI,CAAG,MAAM,CACL,EAAE,GAAVH,CAAU,GACVG,CAAI,CAAGvD,CAAO,CAACwD,QAAQ,CAACJ,CAAG,CAAC,EAEhCjD,CAAO,CAACsD,OAAO,CAAC,WAAW,CAAGF,CAAI,CAAC,CACvC,CAAC,CACD,IAAI,CAACG,SAAS,CAAG,UAAW,SACnB,IAAI,CAAClD,MAAM,EAAE,EAGXN,CACX,CAAC,CACD,IAAI,CAACyD,QAAQ,CAAG,SAASC,CAAK,CAAE,CACvB,IAAI,CAACpD,MAAM,EAAE,EAGlBN,CAAM,CAACyD,QAAQ,CAAC,YAAY,CAAGC,CAAK,CACxC,CAAC,CACD,IAAI,CAACC,IAAI,CAAG,UAAW,CAEnB,GADA,IAAI,CAACC,YAAY,EAAE,CACA,WAAW,EAA1B,MAAO,CAAAC,GAAmB,CAM1B,MALA,CAAA/D,CAAO,CAACgE,UAAU,CAAC,CAAC,uBAAuB,CACvC,sCAAsC,CAAC,CACvC,UAAW,CACP/D,CAAI,CAAC4D,IAAI,EACb,CAAC,CAAC,IAGV,GAAI,IAAI,CAACrD,MAAM,EAAE,CACb,MAAO,CAAAN,CAAM,CAChB,GACG,CAAA+D,CAAW,CAAG,IAAI,CAAC5D,cAAc,EAAE,CACnCuB,CAAG,CAAG,IAAI,CAACC,MAAM,EAAE,CAEvB9B,CAAC,CAAC6B,CAAG,CAAC,CAACE,WAAW,CAAC,iCAAiC,CAAC,CACrDiC,GAAG,CAACG,OAAO,CAAC,oBAAoB,CAAC,CACjChE,CAAM,CAAG6D,GAAG,CAACI,IAAI,CAAC,UAAU,CAAG,IAAI,CAACC,KAAK,EAAE,CAAC,CAC5CjE,CAAO,CAAGD,CAAM,CAACmE,UAAU,EAAE,CAC7BnE,CAAM,CAACoE,UAAU,CAAC,CACdC,yBAAyB,GAAM,CAC/BC,cAAc,GAClB,CAAC,CAAC,CACFtE,CAAM,CAACY,QAAQ,CAAC,IAAI,CAACP,UAAU,EAAE,CAAC,CAClCL,CAAM,CAACe,WAAW,CAACgD,CAAW,CAACQ,WAAW,EAAE,CAAC,CAC7CvE,CAAM,CAACyD,QAAQ,CAAC,YAAY,CAAGM,CAAW,CAACS,QAAQ,EAAE,CAAC,CACtDxE,CAAM,CAACyE,eAAe,IAAW,CACjCzE,CAAM,CAACoB,QAAQ,CAAC,CAAC,CAAE,CAAC,CAAC,CACrBpB,CAAM,CAACwB,WAAW,CAACtB,CAAQ,CAAC,CAC5BD,CAAO,CAACyE,cAAc,IAAM,CAC5BzE,CAAO,CAAC0E,UAAU,CAAC,CAAC,CAAC,CAErB1E,CAAO,CAAC2E,cAAc,CAAC,GAAI,CAAAf,GAAG,CAACgB,WAAa,CAAC,CAC7C,IAAI,CAACC,OAAO,IAAM,CAClB,IAAI,CAAC7B,aAAa,EAAE,CAEpBjD,CAAM,CAAC0C,WAAW,CAAC,SAAS,CAAC,CAC7B,GAAI,CAAAqC,CAAY,CAAG,QAAAA,CAAA,CAAW,CAC1B,GAAI,CAAAC,CAAG,CAAGnF,CAAC,CAAC6B,CAAG,CAAG,iBAAiB,CAAC,CACpC,GAAIsD,CAAG,CAACC,MAAM,CAAE,CACZD,CAAG,CAACE,EAAE,CAAC,MAAM,CAAEnB,CAAW,CAACoB,WAAW,CAAC,CACvC,GAAI,CAAAC,CAAM,CAAGvF,CAAC,CAAC,sBAAsB,CAAC,CACtCuF,CAAM,CAACC,OAAO,CAAC,OAAO,CAC1B,CAAC,IACG,CAAAC,UAAU,CAACP,CAAY,CAAE,EAAE,CAEnC,CAAC,CACD/E,CAAM,CAACkF,EAAE,CAAC,QAAQ,CAAE,UAAW,CAC3BnF,CAAI,CAACwF,MAAM,EACf,CAAC,CAAC,CAEFD,UAAU,CAACP,CAAY,CAAE,CAAC,CAAC,CAE3B,GAAI,CAAAS,CAAW,CAAGxF,CAAM,CAACyF,OAAO,CAmBhC,MAlBA,CAAAzF,CAAM,CAACyF,OAAO,CAAG,SAAShE,CAAC,CAAE,CACrBsC,CAAW,CAAC2B,cAAc,CAC1B1F,CAAM,CAAC2F,MAAM,CAAC5B,CAAW,CAAC6B,YAAY,EAAE,CAAC,CAEzCJ,CAAW,CAAChF,IAAI,CAACR,CAAM,CAAEyB,CAAC,CAElC,CAAC,CAEDzB,CAAM,CAACkF,EAAE,CAAC,MAAM,CAAE,SAASW,CAAC,CAAE,CAC1B9B,CAAW,CAAC+B,YAAY,CAACD,CAAC,CAACE,IAAI,CACnC,CAAC,CAAC,CACFlG,CAAC,CAAC6B,CAAG,CAAC,CAACwD,EAAE,CAAC,OAAO,CAAE,GAAG,CAAEnB,CAAW,CAACiC,eAAe,CAAC,CACpDnG,CAAC,CAAC6B,CAAG,CAAG,kBAAkB,CAAC,CAACwD,EAAE,CAAC,MAAM,CAAEnB,CAAW,CAACoB,WAAW,CAAC,CAC/DtF,CAAC,CAAC6B,CAAG,CAAG,kBAAkB,CAAC,CAACwD,EAAE,CAAC,UAAU,CAAEnB,CAAW,CAACkC,eAAe,CAAC,CAEvEpG,CAAC,CAAC6B,CAAG,CAAC,CAACe,IAAI,CAAC,kBAAkB,CAAC,CAACyD,GAAG,CAAC,UAAU,CAAE,QAAQ,CAAC,CACzD,IAAI,CAAChF,UAAU,EAAE,CACjBrB,CAAC,CAAC6B,CAAG,CAAC,CAACe,IAAI,CAAC,kBAAkB,CAAC,CAACyD,GAAG,CAAC,UAAU,CAAE,UAAU,CAAC,CACpDlG,CACX,CAAC,CACD,IAAI,CAACmG,KAAK,CAAG,UAAW,CACpB,IAAI,CAACrB,OAAO,IAAO,CACJ,IAAI,GAAf9E,CAAe,GAGnB,IAAI,CAACU,UAAU,CAACV,CAAM,CAACO,QAAQ,EAAE,CAAC,CAClCP,CAAM,CAACc,OAAO,EAAE,CAChBd,CAAM,CAAG,IAAI,CACbC,CAAO,CAAG,IAAI,CAClB,CACJ,CACJ,CAAC,CACJ"}