define(["jquery","mod_vpl/vplutil"],function(a,b){return function(){var c=this,d=null,e=null,f=c.getFileManager().readOnly,g=this.getContent;this.getContent=function(){return this.isOpen()?d.getValue():g.call(this)};var h=this.setContent;this.setContent=function(a){h.call(this,a),this.isOpen()&&d.setValue(a)};var i=this.destroy;this.destroy=function(){this.isOpen()&&d.destroy(),i.call(this)},this.setFontSize=function(a){this.isOpen()&&d.setFontSize(a)};var j=this.adjustSize;this.adjustSize=function(){return!!j.call(this)&&(d.resize(!0),!0)},this.gotoLine=function(a){this.isOpen()&&(d.gotoLine(a,0),d.scrollToLine(a,!0),d.focus())},this.setReadOnly=function(a){f=a,this.isOpen()&&d.setReadOnly(a)},this.focus=function(){if(this.isOpen()){var b=this.getTId();a(b).removeClass("ui-widget-content ui-tabs-panel"),d.focus()}},this.blur=function(){this.isOpen()&&d.blur()},this.undo=function(){this.isOpen()&&(d.undo(),d.focus())},this.redo=function(){this.isOpen()&&(d.redo(),d.focus())},this.selectAll=function(){this.isOpen()&&(d.selectAll(),d.focus())},this.hasUndo=function(){return!!this.isOpen()&&e.getUndoManager().hasUndo()},this.hasRedo=function(){return!!this.isOpen()&&e.getUndoManager().hasRedo()},this.hasSelectAll=b.returnTrue,this.hasFind=b.returnTrue,this.hasFindReplace=b.returnTrue,this.hasNext=b.returnTrue,this.find=function(){this.isOpen()&&d.execCommand("find")},this.replace=function(){this.isOpen()&&d.execCommand("replace")},this.next=function(){this.isOpen()&&d.execCommand("findnext")},this.getAnnotations=function(){return this.isOpen()?e.getAnnotations():[]},this.setAnnotations=function(b){return!!this.isOpen()&&e.setAnnotations(b)},this.clearAnnotations=function(){return!!this.isOpen()&&e.clearAnnotations()},this.langSelection=function(){if(this.isOpen()){var a=b.fileExtension(this.getFileName()),c="text";""!==a&&(c=b.langType(a)),e.setMode("ace/mode/"+c)}},this.getEditor=function(){return!!this.isOpen()&&d},this.setTheme=function(a){this.isOpen()&&d.setTheme("ace/theme/"+a)},this.open=function(){if(this.showFileName(),"undefined"==typeof ace)return b.loadScript(["../editor/ace9/ace.js","../editor/ace9/ext-language_tools.js"],function(){c.open()}),!1;if(this.isOpen())return d;var g=this.getFileManager(),h=this.getTId();a(h).removeClass("ui-widget-content ui-tabs-panel"),ace.require("ext/language_tools"),d=ace.edit("vpl_file"+this.getId()),e=d.getSession(),d.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),d.setValue(this.getContent()),d.setFontSize(g.getFontSize()),d.setTheme("ace/theme/"+g.getTheme()),d.$blockScrolling=1/0,d.gotoLine(1,0),d.setReadOnly(f),e.setUseSoftTabs(!0),e.setTabSize(4),e.setUndoManager(new ace.UndoManager),this.setOpen(!0),this.langSelection(),d.execCommand("replace");var i=function(){var b=a(h+" div.ace_search");if(b.length){b.on("drop",g.dropHandler);var c=a(".ace_searchbtn_close");c.trigger("click")}else setTimeout(i,50)};d.on("change",function(){c.change()}),setTimeout(i,5);var j=d.onPaste;return d.onPaste=function(a){g.restrictedEdit?d.insert(g.getClipboard()):j.call(d,a)},d.on("copy",function(a){g.setClipboard(a.text)}),a(h).on("paste","*",g.restrictedPaste),a(h+" div.ace_content").on("drop",g.dropHandler),a(h+" div.ace_content").on("dragover",g.dragoverHandler),a(h).find("div.ace_scroller").css("position","static"),this.adjustSize(),a(h).find("div.ace_scroller").css("position","absolute"),d},this.close=function(){this.setOpen(!1);null===d||(this.setContent(d.getValue()),d.destroy(),d=null,e=null)}}});