define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplidefile","mod_vpl/vplidebutton","mod_vpl/vplterminal","mod_vpl/vplvnc"],function(t,e,l,n,a,o,s){var d,r=function(e,c){function p(i){i.originalEvent.dataTransfer.dropEffect=R?"none":"copy",i.preventDefault()}function g(i){if(R)return i.stopImmediatePropagation(),!1;var e=i.originalEvent.dataTransfer;return!!(0<e.files.length)&&(l.readSelectedFiles(e.files,function(e){return C.addFile(e,!0,S,N)},function(){C.fileListVisibleIfNeeded()}),i.stopImmediatePropagation(),!1)}function u(i){return!R||(i.stopPropagation(),!1)}function m(e,i){return!("newHeader"in i&&i.newHeader.hasClass("vpl_ide_accordion_t_grade"))}function h(){function e(e){for(var t,l=e.toLowerCase()+"/",n=0;n<s.length;n++)if(t=s[n].getFileName().toLowerCase()+"/",0===t.indexOf(l)||0===l.indexOf(t))return!0;return!1}function i(e,t){if(l.isBlockly(e))return!1;if(l.isBlockly(t))for(var n=0;n<s.length;n++)if(l.isBlockly(s[n].getFileName()))return!0;return!1}var a=t("#vpl_tabs_ul");t("#vpl_tabs").tabs();var o=t("#vpl_tabs").tabs("widget"),s=[],m=[],h=!0,v=this;(function(){var e;v.setVersion=function(i){e=i},v.getVersion=function(){return e}})(),this.updateFileList=function(){v.generateFileList()},this.fileNameExists=function(e){for(var t=e.toLowerCase(),l=0;l<s.length;l++)if(s[l].getFileName().toLowerCase()==t)return l;return-1},this.restrictedPaste=u,this.dropHandler=g,this.dragoverHandler=p,this.readOnly=O,this.restrictedEdit=R,this.adjustTabsTitles=V,this.minNumberOfFiles=P,this.scrollBarWidth=D;var f="";this.setClipboard=function(e){f=e},this.getClipboard=function(){return f},this.getTabPos=function(e){for(var t=0;t<m.length;t++)if(m[t]==e)return t;return m.length},this.getTheme=function(){return c.theme},this.setTheme=function(e){c.theme=e;for(var t=0;t<s.length;t++)s[t].setTheme(e)},this.addTab=function(e){var i="<a href=\"#vpl_file"+e+"\"></a>";a.append("<li id=\"vpl_tab_name"+e+"\">"+i+"</li>"),o.append("<div id=\"vpl_file"+e+"\" class=\"vpl_ide_file\"></div>")},this.removeTab=function(e){a.find("#vpl_tab_name"+e).remove(),o.find("#vpl_file"+e).remove()},this.open=function(e){var i;if(i="object"==typeof e?e:s[e],!i.isOpen()){var t=i.getId();v.addTab(t),m.push(i),X.setGetkeys(i.open()),o.tabs("refresh"),V(!1),l.delay("updateFileList",v.updateFileList),l.delay("updateMenu",S)}},this.close=function(e){if(e.isOpen()){var i,t=e.getId();e.close(),v.removeTab(t);var n=v.getTabPos(e);return m.splice(n,1),o.tabs("refresh"),V(!1),v.fileListVisible(!0),l.delay("updateFileList",v.updateFileList),l.delay("adjustTabsTitles",V,!1),m.length>n?(i=v.getFilePosById(m[n].getId()),void v.gotoFile(i,"c")):0<n?(i=v.getFilePosById(m[n-1].getId()),void v.gotoFile(i,"c")):void 0}},this.isClosed=function(e){return!s[e].isOpen()},this.fileListVisible=function(e){e===r.vplVisible||(e?l.delay("fileListVisible",function(){r.vplVisible=!0,v.updateFileList(),r.show(),k()}):l.delay("fileListVisible",function(){r.vplVisible=!1,r.hide(),k()}))},this.isFileListVisible=function(){return r.vplVisible},this.fileListVisibleIfNeeded=function(){if(!this.isFileListVisible())for(var e=0;e<s.length;e++)if(!s[e].isOpen())return void this.fileListVisible(!0)},this.setFontSize=function(e){c.fontSize=e;for(var t=0;t<s.length;t++)s[t].setFontSize(e);we.setFontSize(e)},this.getFontSize=function(){return c.fontSize},this.addFile=function(t,a,o,r){if("string"!=typeof t.name||!l.validPath(t.name))return r(B("incorrect_file_name")+" ("+t.name+")"),!1;!0!==a&&(a=!1);var c=this.fileNameExists(t.name);if(-1!=c)return a?(s[c].setContent(t.contents),v.setModified(),o(),l.delay("updateFileList",v.updateFileList),t):(r(B("filenotadded",t.name)),!1);if(e(t.name)||i("",t.name))return r(B("filenotadded",t.name)),!1;if(s.length>=W)return r(B("maxfilesexceeded")+" ("+W+")"),!1;var p=l.getUniqueId(),g=new n(p,t.name,t.contents,this,d);return 1==t.encoding?g.extendToBinary():l.isBlockly(t.name)?g.extendToBlockly():g.extendToCodeEditor(),g.setFileName(t.name),s.push(g),v.setModified(),5<s.length&&v.fileListVisible(!0),o(),g},this.renameFile=function(t,n,a){var o=this.fileNameExists(t);try{if(-1==o)throw new Error("Internal error: File name not found");if(o<P)throw new Error("Internal error: Renaming requested filename");if(s[o].getFileName()==n)return!0;if(!l.validPath(n)||e(n)||i(t,n))throw B("incorrect_file_name");if(l.isBinary(t)&&l.fileExtension(t)!=l.fileExtension(n))throw B("incorrect_file_name");if(l.isBlockly(t)!=l.isBlockly(n)){if(""<s[o].getContent())T(B("delete_file_fq",t),{ok:function(){var e={name:n,contents:"",encoding:0};C.deleteFile(t,a);var i=C.addFile(e,!1,S,N);i&&C.gotoFileName(n)}});else{var d={name:n,contents:"",encoding:0};C.deleteFile(t,a);var r=C.addFile(d,!1,S,a);r&&C.gotoFileName(n)}return!0}s[o].setFileName(n)}catch(i){return a(B("filenotrenamed",n)+": "+i),!1}return v.setModified(),V(!1),l.delay("updateFileList",v.updateFileList),!0},this.deleteFile=function(e,i){var t=this.fileNameExists(e);return-1==t?(i(B("filenotdeleted",e)),!1):t<P?(i(B("filenotdeleted",e)),!1):(v.setModified(),v.close(s[t]),s.splice(t,1),l.delay("updateFileList",v.updateFileList),!0)},this.currentFile=function(){var e=o.tabs("option","active");if(e in m){var i=m[e];if(0===arguments.length)return i;var t=arguments[0];if("function"==typeof i[t]){var l=i[t],n=Array.prototype.slice(arguments);return n.shift(),l.apply(i,n)}}return!1},this.currentPos=function(){return o.tabs("option","active")},this.getFileTab=function(e){for(var t=0;t<m.length;t++)if(m[t].getId()==e)return t;return-1},this.getFilePosById=function(e){for(var t=0;t<s.length;t++)if(s[t].getId()==e)return t;return-1},this.gotoFile=function(e,i){var t=s[e];v.open(t),o.tabs("option","active",v.getFileTab(t.getId())),"c"!==i&&t.gotoLine(parseInt(i,10)),t.focus()},this.gotoFileLink=function(e){var i=t(e),l=i.data("file"),n=-1;if(n=""<l?this.fileNameExists(l):v.getFilePosById(i.data("fileid")),0<=n){var a=i.data("line");return"undefined"==typeof a&&(a="c"),v.gotoFile(n,a),!0}return!1},this.gotoFileName=function(e,i){var t=this.fileNameExists(e);return!!(0<=t)&&("undefined"==typeof i&&(i="c"),v.gotoFile(t,i),!0)},this.getFilesToSave=function(){for(var e,t=[],l=0;l<s.length;l++)e={},e.name=s[l].getFileName(),e.contents=s[l].getContent(),e.encoding=s[l].isBinary()?1:0,t.push(e);return t},this.resetModified=function(){h=!1;for(var e=0;e<s.length;e++)s[e].resetModified();l.delay("updateMenu",S),l.delay("updateFileList",v.updateFileList)},this.setModified=function(){h=!0,l.delay("updateFileList",v.updateFileList),l.delay("updateMenu",S)},this.isModified=function(){return h},this.length=function(){return s.length},this.clearAnnotations=function(){for(var e=0;e<s.length;e++)s[e].clearAnnotations()},this.getFile=function(e){return s[e]},this.getFiles=function(){return s},this.getDirectoryStructure=function(){function e(e){var i=s[e],l=i.getFileName(),n=l.split("/"),a=t;for(var o in n)if(n.hasOwnProperty(o)){var d=n[o];o==n.length-1?a.content[d]={isDir:!1,content:i,pos:e}:(!a.content[d]&&(a.content[d]={isDir:!0,content:{}}),a=a.content[d])}}var t={isDir:!0,content:{}};for(var l in s)s.hasOwnProperty(l)&&e(l);return t},this.generateFileList=function(){function e(i,t,n){for(var a in i.content)if(i.content.hasOwnProperty(a)){var o=i.content[a];if(o.isDir)n.push(t+l.iconFolder()+l.sanitizeText(a)),e(o,t+"<span class=\"vpl_ide_dirindent\"></span>",n);else{var s=o.content,d=l.sanitizeText(a),r=l.sanitizeText(s.getFileName());s.isOpen()&&(d="<b>"+d+"</b>");var c="href=\"#\" data-fileid=\""+s.getId()+"\" title=\""+r+"\"",p="<a "+c+">"+d+"</a>";s.isModified()&&(p=l.iconModified()+p),o.pos<P&&(p+=l.iconRequired()),n.push(t+p)}}}if(v.isFileListVisible()){var t="<span class=\"vpl_ide_dirindent\"></span>",n=v.getDirectoryStructure(),a=[],o="";e(n,"",a);for(var s=0;s<a.length;s++)o+=a[s]+"<br>";J.html("<div>"+o+"</div>")}},a.on("click","span.vpl_ide_closeicon",function(){C.close(C.currentFile())}),a.on("dblclick","span.vpl_ide_closeicon",X.getAction("delete")),a.on("dblclick","a",X.getAction("rename")),J.on("dblclick","a",X.getAction("rename"))}function v(){return!1===te&&(te=($.outerWidth(!0)-$.width())/2),te}function f(i,e){var t,l=e.position.left-e.originalPosition.left;if(0!=l)t=$.width()+r.width()-r.vplMinWidth,$.resizable("option","maxWidth",t),r.width(r.vplOriginalWidth+l);else{t=$.width()+ee.width()-ee.vplMinWidth,$.resizable("option","maxWidth",t);var n=e.size.width-e.originalSize.width;ee.width(ee.vplOriginalWidth-n)}C.currentFile("adjustSize")}function _(){var e=["e","w","e","e, w"],i=0;i+=r.vplVisible?1:0,i+=ee.vplVisible?2:0,$.resizable("destroy"),le.handles=e[i],le.disable=0===i,$.resizable(le)}function b(){var e=t(window).outerHeight();e-=G.offset().top+G.height()+(j?v():20),150>e&&(e=150),Y.height(e);var i=e-3*v();$.height(i),ee.vplVisible&&(ee.height(i+v()),ie.accordion("refresh")),r.vplVisible&&(J.height(i-(Q.outerHeight()+v())),r.height(i))}function F(){C.currentFile("focus")}function T(e,i){return l.showMessage(e,t.extend({},ne,i))}function w(e){if("click"!=e.type&&("keypress"!=e.type||13!=e.keyCode))return!0;ae.dialog("close");var i={name:t("#vpl_ide_input_newfilename").val(),contents:"",encoding:0},l=C.addFile(i,!1,S,N);return!!l&&(C.open(l),$.tabs("option","active",C.getTabPos(l)),l.focus(),!0)}function x(e){"click"!=e.type&&("keypress"!=e.type||13!=e.keyCode)||(se.dialog("close"),C.renameFile(C.currentFile("getFileName"),t("#vpl_ide_input_renamefilename").val(),N),e.preventDefault())}function y(){l.requestAction("resetfiles","",{},c.ajaxurl).done(function(e){var i=e.files;for(var t in i)i.hasOwnProperty(t)&&C.addFile(i[t],!0,l.doNothing,N);C.fileListVisibleIfNeeded(),l.delay("updateMenu",S)}).fail(N)}function L(e,i,t){t||(t={}),ye.isConnected()||l.requestAction(e,"",t,c.ajaxurl).done(function(t){l.webSocketMonitor(t,e,i,I)}).fail(N)}function M(){L("run","running",{XGEOMETRY:xe.getCanvasSize()})}function A(){L("debug","debugging",{XGEOMETRY:xe.getCanvasSize()})}function z(){L("evaluate","evaluating")}var C,V,k,N,S,I,H=this,P=c.minfiles||0,W=c.maxfiles||0,R=c.restrictededitor||c.example,O=c.example,E=c.isTeacher,j=!1,D=l.scrollBarWidth(),B=l.str,q=t("#"+e);if(t("head").append("<meta name=\"viewport\" content=\"initial-scale=1\">").append("<meta name=\"viewport\" width=\"device-width\">").append("<link rel=\"stylesheet\" href=\"../editor/VPLIDE.css\"/>"),"object"!=typeof q)throw new Error("VPL: constructor tag_id not found");var K={new:!0,rename:!0,delete:!0,save:!0,run:!0,edit:!0,debug:!0,evaluate:!0,import:!0,resetfiles:!0,sort:!0,multidelete:!0,acetheme:!0,console:!0,comments:!0};"undefined"==typeof c.loadajaxurl&&(c.loadajaxurl=c.ajaxurl),function(){var e=P<W;c.new=e,c.rename=e,c.delete=e,c.comments=c.comments&&!c.example,c.acetheme=!0}(),c.sort=2<=W-P,c.multidelete=c.sort,c.import=!R;var U=function(e){return!K[e]||c[e]};c.console=U("run")||U("debug"),"undefined"==typeof c.fontSize&&(c.fontSize=12),c.fontSize=parseInt(c.fontSize),q.on("drop",g),q.on("dragover",p);var G=t("#vpl_menu"),X=new a(G,U),Y=t("#vpl_tr"),r=t("#vpl_filelist"),Q=t("#vpl_filelist_header"),J=t("#vpl_filelist_content"),Z=t("#vpl_tabs_ul"),$=t("#vpl_tabs"),ee=t("#vpl_results"),ie=t("#vpl_results_accordion");r.vplMinWidth=80,ee.vplMinWidth=100,this.updateEvaluationNumber=function(e){if("undefined"!=typeof e.nevaluations){var i=e.nevaluations;"undefined"!=typeof e.reductionbyevaluation&&""<e.reductionbyevaluation&&0!=e.reductionbyevaluation&&(0!=e.freeevaluations&&(i=i+"/"+e.freeevaluations),i=i+" -"+e.reductionbyevaluation),X.setExtracontent("evaluate",i)}},this.lastResult=null,this.getTerminal=function(){return we},this.setResultGrade=function(e,i){var t="grade",l="vpl_ide_accordion_t_grade",n="vpl_ide_accordion_c_grade";if(0==ie.find("."+n).length&&(ie.append("<div class=\""+l+"\"></div>"),ie.append("<div class=\""+n+"\"></div>")),"undefined"==typeof i)return 0<ie.find("h4."+l).length;var a=ie.find("."+l);return""<e?(a.replaceWith("<h4 class=\""+l+"\">"+e+"</h4>"),!0):(a.replaceWith("<div class=\""+l+"\"></div>"),!1)},this.setResultTab=function(e,i,l){var n="vpl_ide_accordion_t_"+e,a="vpl_ide_accordion_c_"+e;if(0==ie.find("."+a).length&&(ie.append("<div class=\""+n+"\"></div>"),ie.append("<div class=\""+a+"\"></div>")),"undefined"==typeof l)return 0<ie.find("h4."+n).length;var o=ie.find("."+n),s=ie.find("."+a),d=t("<div>"+i+"</div>");return d.find("h4").replaceWith(function(){return t("<h5>").append(t(this).contents())}),s.html()==d.html()?""<i:""<i?(o.replaceWith("<h4 class=\""+n+"\">"+B(e)+"</h4>"),s.replaceWith("<div class=\"ui-widget "+a+"\">"+d.html()+"</div>"),!0):(o.replaceWith("<div class=\""+n+"\"></div>"),s.replaceWith("<div class=\""+a+"\"></div>"),!1)},this.setResult=function(e,n){H.updateEvaluationNumber(e);var a,o=C.getFiles(),s=[];for(a=0;a<o.length;a++)s[a]=o[a].getFileName(),o[a].clearAnnotations();var d,r,c,p=!1,g=l.sanitizeText(e.grade);if(r=H.setResultGrade(g,e.grade),p=p||r,d=H.setResultTab("variables",e.variables,e.variables),p=p||d,c=l.processResult(e.compilation,s,o,!0,!1),d=H.setResultTab("compilation",c,e.compilation),p=p||d,c=l.processResult(e.evaluation,s,o,!1,!1),d=H.setResultTab("comments",c,e.evaluation),p=p||d,c=l.sanitizeText(e.execution),d=H.setResultTab("execution",c,e.execution),p=p||d,d=H.setResultTab("description",window.VPLDescription,window.VPLDescription),d&&"object"==typeof MathJax){var u=ie.find(".vpl_ide_accordion_c_description")[0];MathJax.Hub.Queue(["Typeset",MathJax.Hub,u])}if(p=p||d,p){for(ee.removeClass(),ee.addClass(["vpl_ide_results","terminal"==C.getTheme()?"ace-terminal-theme":"ace-"+(C.getTheme()||"chrome").replaceAll("_","-")]),ee.show(),ee.vplVisible=!0,ie.accordion("refresh"),ie.accordion("option","active",r?1:0),ie.children().removeClass("ui-widget-content"),a=0;a<o.length;a++)for(var m=o[a].getAnnotations(),h=0;h<m.length;h++)if(n||"error"==m[h].type){C.gotoFile(a,m[h].row+1);break}t("#vpl_ide_rightpanel").show()}else ee.hide(),ee.vplVisible=!1,t("#vpl_ide_rightpanel").hide();l.delay("autoResizeTab",k)},ie.accordion({heightStyle:"fill",header:"h4",animate:!1,beforeActivate:m}),ee.width(2*ee.vplMinWidth),ie.on("click","a",function(e){C.gotoFileLink(e.currentTarget)&&e.preventDefault()}),ee.vplVisible=!1,ee.hide(),r.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),Q.text(B("filelist")),Q.html(l.iconFolder()+Q.html()),Q.addClass("ui-widget-header ui-button-text-only ui-corner-all"),J.addClass("ui-widget ui-corner-all"),r.width(2*r.vplMinWidth),r.on("click","a",function(e){e.preventDefault(),C.gotoFileLink(e.currentTarget)}),r.vplVisible=!1,r.hide();var te=!1,le={containment:"parent",resize:f,start:function(){t(window).off("resize",k),$.resizable("option","minWidth",100),ee.vplVisible&&(ee.vplOriginalWidth=ee.width()),r.vplVisible&&(r.vplOriginalWidth=r.width())},stop:function(i,e){f(i,e),$.resizable("option","maxWidth",1e5),$.resizable("option","minWidth",0),k(),t(window).on("resize",k)},handles:""};$.resizable(le),V=function(e){var i=$.width(),l=0;Z.width(1e5);var n=Z.children("li:visible").last();if(n.length){var a=Z.parent().scrollLeft();l=a+n.position().left+n.width()+te,Z.width(l);var o=C.currentFile();if(o&&e){var s=t(o.getTabNameId()),d=a+s.position().left;d-=(i-s.outerWidth())/2,0>d&&(d=0),Z.parent().finish().animate({scrollLeft:d},"slow")}}l<i&&Z.width("")},k=function(){var e=$.width(),i=G.width(),t=!1;if(_(),Y.width(G.outerWidth()),r.vplVisible){var l=r.outerWidth()+te;e+=l,100<=l?(i-=l,$.css("left",l)):t=!0}else $.css("left",0);if(ee.vplVisible){var n=ee.outerWidth()+te;e+=n,i-=n,100>i&&(t=!0)}if(t){var a=G.width()/e,o=0;r.vplVisible&&(o=r.width()*a,r.width(o-te),o+=te,$.css("left",o)),$.width($.width()*a),ee.vplVisible&&ee.width(G.width()-(o+$.width()+te))}else $.width(i);V(!0),b(),C.currentFile("adjustSize")};var ne=t.extend({},{close:F},l.dialogbaseOptions);N=function(e){return l.showErrorMessage(e,{close:F})};var ae=t("#vpl_ide_dialog_new"),oe={};oe[B("ok")]=w,oe[B("cancel")]=function(){t(this).dialog("close")},ae.find("input").on("keypress",w),ae.dialog(t.extend({},ne,{title:B("create_new_file"),buttons:oe})),l.setDialogTitleIcon(ae,"new");var se=t("#vpl_ide_dialog_rename");se.find("input").on("keypress",x),oe[B("ok")]=x,se.dialog(t.extend({},ne,{open:function(){t("#vpl_ide_input_renamefilename").val(C.currentFile("getFileName"))},title:B("rename_file"),buttons:oe})),l.setDialogTitleIcon(se,"rename"),oe[B("ok")]=function(){t(this).dialog("close")};var de=t("#vpl_ide_dialog_comments");de.dialog(t.extend({},ne,{title:B("comments"),width:"40em",buttons:oe})),l.setDialogTitleIcon(de,"comments"),t("#vpl_ide_input_comments").width("30em");var re=t("#vpl_ide_dialog_about"),ce={};ce[B("ok")]=function(){t(this).dialog("close")};var pe=t("#vpl_ide_dialog_shortcuts");pe.dialog(t.extend({},ne,{open:function(){var e=X.getShortcuts(C.currentFile("getEditor"));t("#vpl_ide_dialog_shortcuts").html(e)},title:B("shortcuts"),width:400,height:300,buttons:ce})),pe.dialog("option","height",300),l.setDialogTitleIcon(pe,"shortcuts"),ce[B("shortcuts")]=function(){t(this).dialog("close"),pe.dialog("open")},re.dialog(t.extend({},ne,{open:function(){var e=X.getShortcuts(C.currentFile("getEditor"));re.next().find("button").filter(function(){return t(this).text()==B("shortcuts")}).button(""==e?"disable":"enable")},title:B("about"),width:400,height:300,buttons:ce})),re.dialog("option","height",300),l.setDialogTitleIcon(re,"about");var ge=t("#vpl_ide_dialog_sort"),ue={};ue[B("ok")]=function(){var e=C.getFiles(),l=/[^\d]*/,n=[],a=0,o=t("#vpl_sort_list li");if(o.length==e.length){for(o.each(function(){var i=parseInt(this.id.replace(l,""));n.push(e[i])}),a=0;a<o.length;a++)e[a]=n[a];C.setModified(),t(this).dialog("close")}},ue[B("cancel")]=function(){t(this).dialog("close")},ge.dialog(t.extend({},ne,{title:B("sort"),buttons:ue,open:function(){var e=t("#vpl_sort_list");e.html("");for(var l,n=C.getFiles(),a=0;a<n.length;a++)l=t("<li id=\"vpl_fsort_"+a+"\"class=\"ui-widget-content\"></li>"),a<P&&l.addClass("ui-state-disabled"),l.text(a+1+"-"+n[a].getFileName()),e.append(l);e.sortable({items:"li:not(.ui-state-disabled)",placeholder:"ui-state-highlight",start:function(e,i){i.item.addClass("ui-state-highlight")},stop:function(e,i){i.item.removeClass("ui-state-highlight")}}),e.disableSelection()},maxHeight:400})),l.setDialogTitleIcon(ge,"sort");var me=t("#vpl_ide_dialog_multidelete"),he={};he[B("selectall")]=function(){t(this).find("input").prop("checked",!0)},he[B("deselectall")]=function(){t(this).find("input").prop("checked",!1)},he[B("deleteselected")]=function(){var e=C.getFiles(),n=[],a=t("#vpl_multidelete_list label");a.each(function(){var i=t(this);if(i.find("input").prop("checked")){var l=i.data("fileid");n.push(e[l].getFileName())}});for(var o=0;o<n.length;o++)C.deleteFile(n[o],N);l.delay("updateMenu",S),l.delay("updateFileList",C.updateFileList),t(this).dialog("close")},he[B("cancel")]=function(){t(this).dialog("close")},me.dialog(t.extend({},ne,{title:B("multidelete"),buttons:he,open:function(){var e=t("#vpl_multidelete_list");e.html("");for(var n=C.getFiles(),a=P;a<n.length;a++){var o=l.sanitizeText(n[a].getFileName()),s=t("<label><input type=\"checkbox\"> "+o+"</label>");s.data("fileid",a),e.append(s),e.append("<br>")}e.find("label").button()},maxHeight:400,maxWidth:400})),l.setDialogTitleIcon(me,"multidelete");var ve=t("#vpl_ide_dialog_fontsize"),fe=t("#vpl_ide_dialog_fontsize .vpl_fontsize_slider"),_e={};_e[B("ok")]=function(){var e=fe.slider("value");C.setFontSize(e),t(this).dialog("close"),t.ajax({async:!0,type:"POST",url:"../editor/userpreferences.json.php",data:JSON.stringify({fontSize:e}),contentType:"application/json; charset=utf-8",dataType:"json"})},_e[B("cancel")]=function(){C.setFontSize(fe.data("vpl_fontsize")),t(this).dialog("close")},_e[B("reset")]=function(){fe.slider("value",12)},ve.dialog(t.extend({},ne,{title:B("fontsize"),buttons:_e,open:function(){fe.data("vpl_fontsize",C.getFontSize()),fe.slider("value",C.getFontSize())}})),fe.slider({min:1,max:48,change:function(){var e=fe.slider("value");C.setFontSize(e),ve.find(".vpl_fontsize_slider_value").text(e)}}),l.setDialogTitleIcon(ve,"fontsize");var be=t("#vpl_ide_dialog_acetheme"),Fe=t("#vpl_ide_dialog_acetheme select"),Te={};Te[B("ok")]=function(){C.setTheme(Fe.val()),t(this).dialog("close"),l.setUserPreferences({aceTheme:Fe.val()})},Te[B("cancel")]=function(){C.setTheme(Fe.data("acetheme")),t(this).dialog("close")},Te[B("reset")]=function(){Fe.val(Fe.data("acetheme")),C.setTheme(Fe.val())},be.dialog(t.extend({},ne,{title:B("theme"),buttons:Te,modal:!1,open:function(){Fe.data("acetheme",C.getTheme()),Fe.val(C.getTheme())}})),Fe.on("change",function(){t(vpl_results).removeClass(),t(vpl_results).addClass(["vpl_ide_results","terminal"==Fe.val()?"ace-terminal-theme":"ace-"+(Fe.val()||"chrome").replaceAll("_","-")]),C.setTheme(Fe.val())}),l.setDialogTitleIcon(be,"theme");var we=new o("vpl_dialog_terminal","vpl_terminal",B),xe=new s("vpl_dialog_vnc",B),ye=we,Le=t("#vpl_ide_input_file"),Me=function(){l.readSelectedFiles(this.files,function(e){return C.addFile(e,!0,S,N)},function(){C.fileListVisibleIfNeeded()})};Le.on("change",Me),X.add({name:"filelist",originalAction:function(){C.fileListVisible(!C.isFileListVisible()),l.delay("updateMenu",S),l.delay("autoResizeTab",k),l.delay("updateFileList",C.updateFileList)},bindKey:{win:"Ctrl-L",mac:"Ctrl-L"}}),X.add({name:"new",originalAction:function(){C.length()<W&&ae.dialog("open")},bindKey:{win:"Alt-N",mac:"Option-N"}}),X.add({name:"rename",originalAction:function(){var e=C.currentFile();e&&C.getFilePosById(e.getId())>=P&&se.dialog("open")},bindKey:{win:"Ctrl-R",mac:"Ctrl-R"}}),X.add({name:"delete",originalAction:function(){var e=C.currentFile();if(e){var i=e.getFileName(),t=B("delete_file_fq",i);T(t,{ok:function(){C.deleteFile(i,N)},title:B("delete_file_q"),icon:"trash"})}},bindKey:{win:"Ctrl-D",mac:"Ctrl-D"}}),X.add({name:"close",originalAction:function(){var e=C.currentFile();e&&C.close(e)},bindKey:{win:"Alt-W",mac:"Option-W"}}),X.add({name:"import",originalAction:function(){Le.val(""),Le.trigger("click")},bindKey:{win:"Ctrl-I",mac:"Ctrl-I"}}),X.add({name:"sort",originalAction:function(){ge.dialog("open")},bindKey:{win:"Ctrl-O",mac:"Ctrl-O"}}),X.add({name:"multidelete",originalAction:function(){me.dialog("open")}}),X.add({name:"fontsize",originalAction:function(){ve.dialog("open")}}),X.add({name:"theme",originalAction:function(){be.dialog("open")}}),X.add({name:"print",originalAction:function(){window.print()},bindKey:{win:"Alt-P",mac:"Command-P"}}),X.add({name:"undo",originalAction:function(){C.currentFile("undo")}}),X.add({name:"redo",originalAction:function(){C.currentFile("redo")}}),X.add({name:"select_all",editorName:"selectall",originalAction:function(){C.currentFile("selectAll")}}),X.add({name:"find",originalAction:function(){C.currentFile("find")}}),X.add({name:"find_replace",editorName:"replace",originalAction:function(){C.currentFile("replace")}}),X.add({name:"next",editorName:"findnext",originalAction:function(){C.currentFile("next")}}),X.add({name:"fullscreen",originalAction:function(){var e="header, nav, footer, aside, .dropdown, #page-header, div.navbar, #nav-drawer";e+=", div.tabtree, #dock, .breadcrumb-nav, .moodle-actionmenu",j?(q.removeClass("vpl_ide_root_fullscreen"),t("body").removeClass("vpl_body_fullscreen"),X.setText("fullscreen","fullscreen"),t(e).show(),t("#vpl_ide_user").hide(),j=!1):(t("body").addClass("vpl_body_fullscreen").scrollTop(0),t(e).hide(),q.addClass("vpl_ide_root_fullscreen"),X.setText("fullscreen","regularscreen"),c.username&&t("#vpl_ide_user").show(),j=!0),F(),setTimeout(k,10)},bindKey:{win:"Alt-F",mac:"Ctrl-F"}}),X.add({name:"download",originalAction:function(){window.location=c.download}}),X.add({name:"resetfiles",originalAction:function(){T(B("sureresetfiles"),{title:B("resetfiles"),ok:y,icon:"resetfiles"})}}),X.add({name:"save",originalAction:function(){function e(){const t=/^lang_[^_]+_[^_]+\.json$/;let a=!1;for(let e=0;e<n.files.length;e++)if(file=n.files[e],t.test(file.name))try{JSON.parse(file.contents)}catch(i){if(i instanceof SyntaxError){a=!0,N(`Enhance configuration file ${file.name} with parse error`);break}else throw i}a||l.requestAction("save","saving",n,c.ajaxurl).done(function(i){i.requestsconfirmation?T(i.question,{title:B("saving"),icon:"alert",yes:function(){n.version=0,e()}}):(C.resetModified(),C.setVersion(i.version),X.setTimeLeft(i),l.delay("updateMenu",S),l.monitorRunning()&&(n.processid=l.getProcessId(),l.requestAction("update","updating",n,c.ajaxurl)))}).fail(N)}var n={files:C.getFilesToSave(),comments:t("#vpl_ide_input_comments").val(),version:C.getVersion()};return JSON.stringify(n).length>c.postMaxSize?void N(B("maxpostsizeexceeded")):void e()},bindKey:{win:"Ctrl-S",mac:"Command-S"}}),X.add({name:"run",originalAction:function(){I.setLastAction(M),M()},bindKey:{win:"Ctrl-F11",mac:"Command-U"}}),X.add({name:"debug",originalAction:function(){I.setLastAction(A),A()},bindKey:{win:"Alt-F11",mac:"Option-U"}}),X.add({name:"evaluate",originalAction:function(){I.setLastAction(z),z()},bindKey:{win:"Shift-F11",mac:"Command-Option-U"}}),X.add({name:"comments",originalAction:function(){de.dialog("open")}}),X.add({name:"console",originalAction:function(){ye.isOpen()?ye.close():ye.show()}}),X.add({name:"user"}),X.add({name:"about",originalAction:function(){re.dialog("open")}}),X.add({name:"timeleft",originalAction:function(){X.toggleTimeLeft()}}),X.add({name:"more",originalAction:function(){var e=t("#vpl_ide_menuextra");e.is(":visible")?(X.setText("more","more",l.str("more")),e.hide()):(X.setText("more","less",l.str("less")),e.show()),l.delay("updateMenu",S),l.delay("autoResizeTab",k)}}),X.add({name:"rightpanel",icon:"close-rightpanel",originalAction:function(){ee.vplVisible?(ee.hide(),ee.vplVisible=!1,X.setText("rightpanel","open-rightpanel",l.str("rightpanel"))):(X.setText("rightpanel","close-rightpanel",l.str("rightpanel")),ee.show(),ee.vplVisible=!0),l.delay("autoResizeTab",k)},bindKey:{win:"Ctrl-M",mac:"Ctrl-M"}});Y.append("<span style=\"position:absolute;right:0;top:60px;z-index:100;margin:3px\">"+X.getHTML("rightpanel")+"</span>");var Ae=t("#vpl_ide_rightpanel");X.setText("rightpanel","close-rightpanel",l.str("rightpanel")),Ae.button(),Ae.css("padding","0"),t("#vpl_ide_rightpanel.ui-button-text").css("padding","0"),Ae.on("click",function(){X.launchAction("rightpanel")}),Ae.hide(),G.addClass("ui-widget-header ui-corner-all");var ze="";ze+=X.getHTML("more"),ze+=X.getHTML("save"),ze+="<span id='vpl_ide_mexecution'>",ze+=X.getHTML("run"),ze+=X.getHTML("debug"),ze+=X.getHTML("evaluate"),ze+=X.getHTML("comments"),ze+=X.getHTML("console"),ze+="</span> ",ze+="<span id='vpl_ide_menuextra'>",ze+="<span id='vpl_ide_file'>",ze+=X.getHTML("filelist"),ze+=X.getHTML("new"),ze+=X.getHTML("rename"),ze+=X.getHTML("delete"),ze+=X.getHTML("import"),ze+=X.getHTML("download"),ze+=X.getHTML("resetfiles"),ze+=X.getHTML("sort"),ze+=X.getHTML("multidelete"),ze+=X.getHTML("fontsize"),ze+=X.getHTML("theme"),ze+="</span> ",ze+="<span id='vpl_ide_edit'>",ze+=X.getHTML("undo"),ze+=X.getHTML("redo"),ze+=X.getHTML("select_all"),ze+=X.getHTML("find"),ze+=X.getHTML("find_replace"),ze+=X.getHTML("next"),ze+="</span> ",ze+="</span> ",ze+=X.getHTML("fullscreen")+" ",ze+=X.getHTML("about")+" ",ze+=X.getHTML("user")+" ",ze+=X.getHTML("timeleft"),ze+="<div class=\"clearfix\"></div>",G.append(ze),t("#vpl_ide_more").button(),t("#vpl_ide_save").button(),t("#vpl_ide_menuextra").hide(),t("#vpl_ide_file").controlgroup(),t("#vpl_ide_edit").controlgroup(),t("#vpl_ide_mexecution").controlgroup(),t("#vpl_ide_fullscreen").button(),t("#vpl_ide_acetheme").button(),t("#vpl_ide_about").button(),t("#vpl_ide_user").button().css("float","right").hide(),t("#vpl_ide_timeleft").button().css("float","right").hide(),t("#vpl_menu .ui-button").css("padding","6px"),t("#vpl_menu .ui-button-text").css("padding","0");for(var Ce=["filelist","more","fullscreen","about","resetfiles","download","comments","console","import","fontsize","timeleft"],Ve=0;Ve<Ce.length;Ve++)X.enable(Ce[Ve],!0);X.setExtracontent("user",c.username),X.setTimeLeft(c),S=function(){var e,t=C.currentFile(),n=C.length();n?$.show():$.hide(),C.isFileListVisible()?X.setText("filelist","filelistclose",l.str("filelist")):X.setText("filelist","filelist",l.str("filelist"));var a=C.isModified();X.enable("save",a);var o=l.monitorRunning();o?X.setText("run","running"):X.setText("run","run"),X.enable("run",!o&&(!a||c.example)&&U("run")),X.enable("debug",!o&&(!a||c.example)&&U("debug")),X.enable("evaluate",!o&&(!a||c.example)&&U("evaluate")),X.enable("download",!a),X.enable("new",n<W),X.enable("sort",1<n-P),X.enable("multidelete",1<n-P),X.enable("theme",!0);var s;if(!t||0===n){for(s=["rename","delete","undo","redo","select_all","find","find_replace","next"],e=0;e<s.length;e++)X.enable(s[e],!1);return}var d=C.getFilePosById(t.getId());X.enable("rename",d>=P&&0!==n),X.enable("delete",d>=P&&0!==n),X.enable("undo",t.hasUndo()),X.enable("redo",t.hasRedo()),X.enable("select_all",t.hasSelectAll()),X.enable("find",t.hasFind()),X.enable("find_replace",t.hasFindReplace()),X.enable("next",t.hasNext()),l.delay("updateFileList",C.updateFileList)},I={open:S,close:S,getConsole:function(){return ye},setResult:H.setResult,ajaxurl:c.ajaxurl,run:function(e,i,n){var a=/^([^:]*):?(.*)/i.exec(e),o=a[1];if("terminal"==o||"webterminal"==o){if(ye&&ye.isOpen()&&ye.close(),ye=we,we.connect(i.executionURL,function(){n.close(),F()}),"webterminal"==o){var s=(i.secure?"https":"http")+"://"+i.server+":"+i.portToUse;s+="/favicon.ico";var d=t("<img>");d.attr("src",s),d.attr("style","display:none"),t("body").append(d)}}else if("vnc"==o)ye&&ye.isOpen()&&ye.close(),ye=xe,xe.connect(i.secure,i.server,i.portToUse,i.VNCpassword,i.executionPath,function(){n.close(),F()});else if("browser"==o){var r=(i.secure?"https":"http")+"://"+i.server+":"+i.portToUse+"/";r+=a[2]+"/httpPassthrough",E&&(r+="?private");var c="<a href=\""+r+"\" target=\"_blank\">";c+=l.str("open")+"</a>";var p={width:200,icon:"run",title:l.str("run")};T(c,p)}else l.log("Type of run error "+e,!0)},lastAction:!1,getLastAction:function(){var e=this.lastAction;return this.lastAction=!1,e},setLastAction:function(e){this.lastAction=e}},$.on("tabsactivate",function(){C.currentFile("focus"),l.delay("updateMenu",S),l.delay("autoResizeTab",k)});var ke=t(window);ke.on("resize",k),c.example||ke.on("beforeunload",function(){return C.isModified()?B("changesNotSaved"):void 0}),C=new h,k(),function(){function e(){var e=G.width();i!=e&&(i=e,k())}var i=G.width();e(),setInterval(e,1e3)}(),C.resetModified(),l.requestAction("load","loading",c,c.loadajaxurl).done(function(e){for(var n=!0,a=e.files,o=!1,s=0;s<a.length;s++){var d=a[s],p=C.addFile(d,!1,S,N);p?(p.resetModified(),s<P||5>=a.length?C.open(p):o=!0):n=!1}$.tabs("option","active",0),e.compilationexecution&&H.setResult(e.compilationexecution,!1),X.setTimeLeft(e),""<e.comments&&t("#vpl_ide_input_comments").val(e.comments),n?C.resetModified():C.setModified(),0===C.length()&&0<W?X.getAction("new")():!c.saved&&C.setModified(),C.setFontSize(c.fontSize),C.setVersion(e.version),C.fileListVisible(o),l.afterAll("AfterLoadFiles",function(){S(),k(),V(!0)})}).fail(N)};return window.VPLIDE=r,{init:function(e,i){d=new r(e,i)}}});