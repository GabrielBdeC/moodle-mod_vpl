define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard"],function(a,b,c,d){var e=function(b,e,f){function g(a){if(w+=a,64000<w.length){var b=w.length-32000;w=w.substr(b)}}function h(){o&&o.readyState==o.OPEN&&o.send(v.getEntry2())}function i(){v.setEntry1(w)}function j(){i(),v.show()}function k(a){var b="vpl_terminal_theme",d=5;s.data("terminal_theme",a),c.setUserPreferences({terminalTheme:a});for(var e=0;e<d;e++)s.removeClass("vpl_terminal_theme"+e);s.addClass("vpl_terminal_theme"+a)}function l(){var a=t.width(),b=t.height();s.width()>a&&s.dialog("option","width",a),s.parent().height()>b&&s.dialog("option","height",b-s.prev().outerHeight())}var m,n=this,o=null,p=c.doNothing,q="",r="",s=a("#"+b),t=a("#vplide"),u="",v=null,w="",x=a("#"+e);this.updateTitle=function(){var a=q;""!==r&&(a+=" ("+r+")"),u.text(f("console")+": "+a)},this.setTitle=function(a){q=a,this.updateTitle()},this.setMessage=function(a){r=a,this.updateTitle()},this.write=function(a){return m.write(a),a},this.connect=function(a,b){p=b,"WebSocket"in window?(m.reset(),m.startBlink(),n.show(),o&&o.close(),w="",n.setMessage(""),n.setTitle(f("connecting")),o=new WebSocket(a),o.writeBuffer="",o.writeIt=function(){m.write(o.writeBuffer),g(o.writeBuffer),o.writeBuffer=""},o.onmessage=function(a){0<o.writeBuffer.length?o.writeBuffer+=a.data:(o.writeBuffer=a.data,setTimeout(o.writeIt,35))},o.onopen=function(){n.setMessage(""),n.setTitle(f("connected"))},o.onclose=function(){n.setTitle(f("connection_closed")),m.blur(),m.stopBlink(),b(),o.stopOutput=!0}):m.write("WebSocket not available: Upgrade your browser")},this.writeLocal=function(a){return o.onmessage({data:a}),a},this.setDataCallback=function(a){o.onData=a},this.closeLocal=function(){o&&(o.writeIt(),o.close(),m.stopBlink(),n.setTitle(f("connection_closed")))},this.connectLocal=function(a,b){p=a,m.reset(),m.startBlink(),n.show(),o&&o.close(),w="",n.setMessage(""),n.setTitle(f("running")),o={},o.onData=b,o.writeBuffer="",o.readBuffer="",o.readyState=1,o.OPEN=1,o.close=function(){o=!1},o.onmessage=function(a){o.writeBuffer=a.data,o.writeIt()},o.writeIt=function(){o&&(m.write(o.writeBuffer),g(o.writeBuffer),o.writeBuffer="")},o.send=function(a){"\x7F"==a?0<o.readBuffer.length&&(n.writeLocal("\b \b"),o.readBuffer=o.readBuffer.substr(0,o.readBuffer.length-1)):(n.writeLocal(a),o.readBuffer+=a);var b=o.readBuffer.indexOf("\r");if(-1!=b){var c=o.readBuffer.substr(0,b);o.readBuffer=o.readBuffer.substr(b+1),o.onData(c)}}},this.isOpen=function(){return s.dialog("isOpen")},this.close=function(){s.dialog("close")},this.isConnected=function(){return o&&o.readyState!=o.CLOSED},this.disconnect=function(){o&&o.readyState==o.OPEN&&(p(),o&&o.close(),m.stopBlink())};var y=c.genIcon("copy","sw")+" "+f("copy"),z=c.genIcon("paste","sw")+" "+f("paste");v=new d("vpl_dialog_terminal_clipboard",y,function(){i(),document.execCommand("copy")},z,h),this.closeDialog=function(){v.hide(),n.disconnect()},s.dialog({closeOnEscape:!1,autoOpen:!1,width:"auto",height:"auto",resizable:!0,dragStop:l,open:l,focus:function(){l(),m.focus()},dialogClass:"vpl_ide vpl_vnc",create:function(){u=c.setTitleBar(s,"console","console",["clipboard","keyboard","theme"],[j,function(){m.focus()},function(){var a=(s.data("terminal_theme")+1)%5;k(a)}])},close:function(){n.closeDialog()},resizeStop:function(){s.width(s.parent().width()),s.height(s.parent().height()-s.prev().outerHeight()),l(),m.focus()}}),this.setFontSize=function(a){x.css("font-size",a+"px")},c.getUserPreferences(function(a){k(a.preferences.terminalTheme)}),s.css("padding","1px"),s.parent().css("z-index",2e3),this.show=function(){s.dialog("open"),m.focus()},this.init=function(){return"undefined"==typeof Terminal?void c.loadScript(["../../vpl/editor/xterm/term.js"],function(){n.init()}):void(m=new Terminal({cols:80,rows:24,useStyle:!0,screenKeys:!0}),m.on("data",function(a){o&&o.readyState==o.OPEN&&o.send(a)}),m.open(x[0]),m.reset(),m.stopBlink(),m.setLineCallback(function(a,b){var c=x.height(),d=s.scrollTop(),e=s.innerHeight();if(!(e>=c)){var f=c/b,g=a*f;g>=d&&g<e+d-f||(g<d?s.scrollTop(g):s.scrollTop(g-e+2*f))}}))},this.init()};return window.VPLTerminal=e,e});