{"version":3,"file":"vplterminal.min.js","names":["define","$","jqui","VPLUtil","VPLClipboard","VPLTerminal","NTHEMES","dialogId","terminalId","str","self","ws","onCloseAction","doNothing","title","message","tdialog","tIde","titleText","clipboard","cliboardMaxsize","clipboardData","terminal","terminalTag","updateTitle","text","setTitle","t","setMessage","receiveClipboard","data","length","from","substr","pasteClipboard","readyState","OPEN","send","getEntry2","updateClipboard","setEntry1","openClipboard","show","write","connect","server","onClose","window","reset","startBlink","close","WebSocket","writeBuffer","writeIt","onmessage","event","setTimeout","onopen","onclose","blur","stopBlink","stopOutput","writeLocal","setDataCallback","call","onData","closeLocal","connectLocal","readBuffer","pos","indexOf","isOpen","dialog","isConnected","CLOSED","disconnect","HTMLUpdateClipboard","genIcon","HTMLPaste","document","execCommand","closeDialog","hide","setTheme","theme","cbase","nthemes","setUserPreferences","terminalTheme","i","removeClass","addClass","controlDialogSize","bw","width","bh","height","parent","prev","outerHeight","closeOnEscape","autoOpen","resizable","dragStop","open","focus","dialogClass","create","setTitleBar","resizeStop","setFontSize","size","css","getUserPreferences","preferences","init","Terminal","loadScript","cols","rows","useStyle","screenKeys","on","setLineCallback","line","nlines","offset","scrollTop","viewHeight","innerHeight","lineHeight"],"sources":["../src/vplterminal.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\n//\n// VPL for Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// VPL for Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Terminal control\n *\n * @copyright 2014 Juan Carlos Rodríguez-del-Pino\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\n */\n\n/* globals Terminal */\n\ndefine(\n    [\n        'jquery',\n        'jqueryui',\n        'mod_vpl/vplutil',\n        'mod_vpl/vplclipboard'\n    ],\n    function($, jqui, VPLUtil, VPLClipboard) {\n        if (typeof VPLTerminal !== 'undefined') {\n            return VPLTerminal;\n        }\n        var NTHEMES = 5;\n        var VPLTerminal = function(dialogId, terminalId, str) {\n            var self = this;\n            var ws = null;\n            var onCloseAction = VPLUtil.doNothing;\n            var title = '';\n            var message = '';\n            var tdialog = $('#' + dialogId);\n            var tIde = $('#vplide');\n            var titleText = '';\n            var clipboard = null;\n            var cliboardMaxsize = 64000;\n            var clipboardData = '';\n\n            var terminal;\n            var terminalTag = $('#' + terminalId);\n            this.updateTitle = function() {\n                var text = title;\n                if (message !== '') {\n                    text += ' (' + message + ')';\n                }\n                titleText.text(str('console') + \": \" + text);\n            };\n            this.setTitle = function(t) {\n                title = t;\n                this.updateTitle();\n            };\n            this.setMessage = function(t) {\n                message = t;\n                this.updateTitle();\n            };\n            /**\n             * Manages the data received from clipboard\n             * @param {string} data Data recieved\n             */\n            function receiveClipboard(data) {\n                clipboardData += data;\n                if (clipboardData.length > cliboardMaxsize) {\n                    var from = clipboardData.length - cliboardMaxsize / 2;\n                    clipboardData = clipboardData.substr(from);\n                }\n            }\n            /**\n             * Sends the clipboard data to the connection\n             */\n            function pasteClipboard() {\n                if (ws && ws.readyState == ws.OPEN) {\n                    ws.send(clipboard.getEntry2());\n                }\n            }\n            /**\n             * Updates the data in the clipboard dialog\n             */\n            function updateClipboard() {\n                clipboard.setEntry1(clipboardData);\n            }\n            /**\n             * Opens the clipboard dialog\n             */\n            function openClipboard() {\n                updateClipboard();\n                clipboard.show();\n            }\n            this.write = function(text) {\n                terminal.write(text);\n                return text;\n            };\n\n            this.connect = function(server, onClose) {\n                onCloseAction = onClose;\n                if (\"WebSocket\" in window) {\n                    terminal.reset();\n                    terminal.startBlink();\n                    self.show();\n                    if (ws) {\n                        ws.close();\n                    }\n                    clipboardData = '';\n                    self.setMessage('');\n                    self.setTitle(str('connecting'));\n                    ws = new WebSocket(server);\n                    ws.writeBuffer = '';\n                    ws.writeIt = function() {\n                        terminal.write(ws.writeBuffer);\n                        receiveClipboard(ws.writeBuffer);\n                        ws.writeBuffer = '';\n                    };\n                    ws.onmessage = function(event) {\n                        if (ws.writeBuffer.length > 0) {\n                            ws.writeBuffer += event.data;\n                        } else {\n                            ws.writeBuffer = event.data;\n                            setTimeout(ws.writeIt, 35);\n                        }\n                    };\n                    ws.onopen = function() {\n                        self.setMessage('');\n                        self.setTitle(str('connected'));\n                    };\n                    ws.onclose = function() {\n                        self.setTitle(str('connection_closed'));\n                        terminal.blur();\n                        terminal.stopBlink();\n                        onClose();\n                        ws.stopOutput = true;\n                    };\n                } else {\n                    terminal.write('WebSocket not available: Upgrade your browser');\n                }\n            };\n            this.writeLocal = function(text) {\n                ws.onmessage({\n                    data: text\n                });\n                return text;\n            };\n            this.setDataCallback = function(call) {\n                ws.onData = call;\n            };\n            this.closeLocal = function() {\n                if (ws) {\n                    ws.writeIt();\n                    ws.close();\n                    terminal.stopBlink();\n                    self.setTitle(str('connection_closed'));\n                }\n            };\n            this.connectLocal = function(onClose, onData) {\n                onCloseAction = onClose;\n                terminal.reset();\n                terminal.startBlink();\n                self.show();\n                if (ws) {\n                    ws.close();\n                }\n                clipboardData = '';\n                self.setMessage('');\n                self.setTitle(str('running'));\n                ws = {};\n                ws.onData = onData;\n                ws.writeBuffer = '';\n                ws.readBuffer = '';\n                ws.readyState = 1;\n                ws.OPEN = 1;\n                ws.close = function() {\n                    ws = false;\n                };\n                ws.onmessage = function(event) {\n                    ws.writeBuffer = event.data;\n                    ws.writeIt();\n                };\n                ws.writeIt = function() {\n                    if (ws) {\n                        terminal.write(ws.writeBuffer);\n                        receiveClipboard(ws.writeBuffer);\n                        ws.writeBuffer = '';\n                    }\n                };\n                ws.send = function(text) {\n                    // Process backspace.\n                    if (text == '\\u007f') {\n                        if (ws.readBuffer.length > 0) {\n                            self.writeLocal('\\b \\b');\n                            ws.readBuffer = ws.readBuffer.substr(0, ws.readBuffer.length - 1);\n                        }\n                    } else {\n                        self.writeLocal(text);\n                        ws.readBuffer += text;\n                    }\n                    var pos = ws.readBuffer.indexOf(\"\\r\");\n                    if (pos != -1) {\n                        var data = ws.readBuffer.substr(0, pos);\n                        ws.readBuffer = ws.readBuffer.substr(pos + 1);\n                        ws.onData(data);\n                    }\n                };\n            };\n            this.isOpen = function() {\n                return tdialog.dialog(\"isOpen\");\n            };\n            this.close = function() {\n                tdialog.dialog(\"close\");\n            };\n            this.isConnected = function() {\n                return ws && ws.readyState != ws.CLOSED;\n            };\n            this.disconnect = function() {\n                if (ws && ws.readyState == ws.OPEN) {\n                    onCloseAction();\n                    if (ws) {\n                        ws.close();\n                    }\n                    terminal.stopBlink();\n                }\n            };\n            var HTMLUpdateClipboard = VPLUtil.genIcon('copy', 'sw') + ' ' + str('copy');\n            var HTMLPaste = VPLUtil.genIcon('paste', 'sw') + ' ' + str('paste');\n            clipboard = new VPLClipboard('vpl_dialog_terminal_clipboard', HTMLUpdateClipboard, function() {\n                    updateClipboard();\n                    document.execCommand('copy');\n                }, HTMLPaste, pasteClipboard);\n            this.closeDialog = function() {\n                clipboard.hide();\n                self.disconnect();\n            };\n            /**\n             * Sets the terminal theme\n             * @param {int} theme\n             */\n            function setTheme(theme) {\n                var cbase = \"vpl_terminal_theme\";\n                var nthemes = 5;\n                tdialog.data('terminal_theme', theme);\n                VPLUtil.setUserPreferences({terminalTheme: theme});\n                for (var i = 0; i < nthemes; i++) {\n                    tdialog.removeClass(cbase + i);\n                }\n                tdialog.addClass(cbase + theme);\n            }\n            /**\n             * Limits the size of the dialogo to the IDE\n             */\n            function controlDialogSize() {\n                // Resize if dialog is large than screen.\n                var bw = tIde.width();\n                var bh = tIde.height();\n                if (tdialog.width() > bw) {\n                    tdialog.dialog(\"option\", \"width\", bw);\n                }\n                if (tdialog.parent().height() > bh) {\n                    tdialog.dialog(\"option\", \"height\", bh - tdialog.prev().outerHeight());\n                }\n            }\n            tdialog.dialog({\n                closeOnEscape: false,\n                autoOpen: false,\n                width: 'auto',\n                height: 'auto',\n                resizable: true,\n                dragStop: controlDialogSize,\n                open: controlDialogSize,\n                focus: function() {\n                    controlDialogSize();\n                    terminal.focus();\n                },\n                dialogClass: 'vpl_ide vpl_vnc',\n                create: function() {\n                    titleText = VPLUtil.setTitleBar(tdialog, 'console', 'console',\n                            ['clipboard', 'keyboard', 'theme'],\n                            [openClipboard,\n                            function() {\n                                terminal.focus();\n                            },\n                            function() {\n                                // Cycle themes from 0 to NTHEMES-1.\n                                var theme = (tdialog.data('terminal_theme') + 1) % NTHEMES;\n                                setTheme(theme);\n                            }]);\n                },\n                close: function() {\n                    self.closeDialog();\n                },\n                resizeStop: function() {\n                    tdialog.width(tdialog.parent().width());\n                    tdialog.height(tdialog.parent().height() - tdialog.prev().outerHeight());\n                    controlDialogSize();\n                    terminal.focus();\n                }\n            });\n            this.setFontSize = function(size) {\n                terminalTag.css(\"font-size\", size + \"px\");\n            };\n            VPLUtil.getUserPreferences(function(data) {\n                setTheme(data.preferences.terminalTheme);\n            });\n            tdialog.css(\"padding\", \"1px\");\n            tdialog.parent().css('z-index', 2000);\n            this.show = function() {\n                tdialog.dialog('open');\n                terminal.focus();\n            };\n            this.init = function() {\n                if (typeof Terminal === 'undefined') {\n                    VPLUtil.loadScript(['../../vpl/editor/xterm/term.js'], function() {\n                                                                               self.init();\n                                                                           });\n                    return;\n                }\n                terminal = new Terminal({\n                    cols: 80,\n                    rows: 24,\n                    useStyle: true,\n                    screenKeys: true\n                });\n                terminal.on('data', function(data) {\n                    if (ws && ws.readyState == ws.OPEN) {\n                        ws.send(data);\n                    }\n                });\n                terminal.open(terminalTag[0]);\n                terminal.reset();\n                terminal.stopBlink();\n                terminal.setLineCallback(\n                    function(line, nlines) {\n                        var height = terminalTag.height();\n                        var offset = tdialog.scrollTop();\n                        var viewHeight = tdialog.innerHeight();\n                        if (viewHeight >= height) {\n                            return;\n                        }\n                        var lineHeight = height / nlines;\n                        var pos = line * lineHeight;\n                        // If cursor in view area return.\n                        if (pos >= offset && pos < (viewHeight + offset - lineHeight)) {\n                            return;\n                        }\n                        if (pos < offset) { // If cursor beforer view area scroll to first view line.\n                            tdialog.scrollTop(pos);\n                        } else {\n                            tdialog.scrollTop((pos - viewHeight) + 2 * lineHeight);\n                        }\n                    }\n                );\n            };\n            this.init();\n        };\n        window.VPLTerminal = VPLTerminal;\n        return VPLTerminal;\n    }\n);\n"],"mappings":"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"}