define(["jquery","jqueryui","mod_vpl/vplutil","mod_vpl/vplclipboard","core/log"],function(a,b,c,d,e){function f(){"undefined"==typeof Util?c.delay("loadVNCScripts",f):Util.load_scripts(["webutil.js","base64.js","websock.js","des.js","keysymdef.js","keyboard.js","input.js","display.js","jsunzip.js","rfb.js","keysym.js"])}window.INCLUDE_URI="../editor/noVNC/include/",c.delay("loadVNCScripts",f);var g=function(b,f){function g(){a(B).is(":focus")?B.blur():B.focus()}function h(){t.isConnected()&&q.clipboardPasteFrom(r.getEntry2())}function i(a,b){r.setEntry1(b)}function j(){r.show()}function k(){t.isConnected()&&q.get_keyboard().set_focused(!0)}function l(){t.isConnected()&&q.get_keyboard().set_focused(!1)}function m(){r.setEntry1(r.getEntry1()),document.execCommand("copy")}function n(){var b=a("html").width(),c=a(window).height();x.width()>b&&(A=!0,x.dialog("option","width",b)),x.parent().height()>c&&(A=!0,x.dialog("option","height",c-x.prev().outerHeight()))}function o(a,b,c,d){w=b;"normal"===b?(t.setMessage(""),t.setTitle(f("connected"))):"disconnect"===b||"disconnected"===b?t.setTitle(f("connection_closed")):"failed"===b?(t.setTitle(f("connection_fail")),e.log("VNC client: "+d)):(t.setMessage(""),t.setTitle(f("connecting")))}function p(a){return 100>a&&(a=100),2*Math.floor(a/2)}var q,r,s,t=this,u="",v="",w="",x=a("#"+b),y=a("#"+b+" canvas"),z=c.doNothing,A=!0,B=window.document.createElement("input");B.style.position="absolute",B.style.left="0px",B.style.top="-10000px",B.style.width="1em",B.style.height="1ex",B.style.opacity="0",B.style.backgroundColor="transparent",B.style.borderStyle="none",B.style.outlineStyle="none",B.autocapitalize="off",B.autocomplete="off",B.autocorrect="off",B.wrap="off",B.spellcheck="false",x.append(B);var C=c.genIcon("copy","sw")+" "+f("copy"),D=c.genIcon("paste","sw")+" "+f("paste");r=new d("vpl_dialog_vnc_clipboard",C,m,D,h,l),y.on("click",function(a){a.target==y[0]?k():l()}),this.displayResize=function(){if(t.isConnected()){var a=x.width(),b=x.height();t.setCanvasSize(a,b),q.get_display().viewportChange(0,0,a,b)}},x.dialog({closeOnEscape:!1,autoOpen:!1,modal:!0,width:"auto",height:"auto",dialogClass:"vpl_ide vpl_vnc",create:function(){s=c.setTitleBar(x,"vnc","graphic",["clipboard","keyboard"],[j,g])},dragStop:n,focus:k,open:n,beforeClose:function(){if(A){var a=x.width(),b=x.height();A=!1,t.setCanvasSize(a,b)}},close:function(){t.disconnect()},resizeStop:function(){n(),A=!0}}),x.css("padding","1px"),x.parent().css("z-index",2e3),this.updateTitle=function(){var a=u;""!==v&&(a+=" ("+v+")"),s.text(f("console")+": "+a)},this.setTitle=function(a){u=a,this.updateTitle()},this.setMessage=function(a){v=a,this.updateTitle()},this.connect=function(c,d,e,f,g,h){r.setEntry1(""),z=h,t.show();var j=a("#"+b+" canvas")[0];q||(q=new RFB({target:j,encrypt:c,repeaterID:"",true_color:!0,local_cursor:!0,shared:!1,view_only:!1,onUpdateState:o,onPasswordRequired:null,onClipboard:i}),q.set_local_cursor(q.get_display().get_cursor_uri())),e||(e=c?443:80),q.connect(d,e,f,g)},this.isOpen=function(){return x.dialog("isOpen")},this.close=function(){x.dialog("close")},this.isConnected=function(){return q&&"disconnected"!=w},this.disconnect=function(){q&&q.disconnect(),z(),r.hide()},this.getCanvasSize=function(){return y.width()+"x"+y.height()},this.setCanvasSize=function(a,b){y.width(p(a)),y.height(p(b))},this.show=function(){x.dialog("open"),x.width("auto"),x.height("auto")},t.setCanvasSize(a(window).width()-150,a(window).height()-150)};return g});